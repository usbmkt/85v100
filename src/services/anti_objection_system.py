#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ARQV30 Enhanced v2.0 - Anti Objection System
Sistema anti-obje√ß√£o com arsenal completo
"""

import logging
import json
from typing import Dict, List, Any, Optional
from .ai_manager import QuantumAIManager
from .auto_save_manager import auto_save_manager

logger = logging.getLogger(__name__)

class AntiObjectionSystem:
    """Sistema Anti-Obje√ß√£o com Arsenal Completo"""

    def __init__(self):
        """Inicializa o sistema anti-obje√ß√£o"""
        self.ai_manager = QuantumAIManager()
        self.auto_save = AutoSaveManager("anti_objecao")

        # Arsenal de obje√ß√µes comuns
        self.common_objections = {
            "preco": [
                "Est√° muito caro",
                "N√£o tenho dinheiro agora",
                "Preciso pensar no investimento"
            ],
            "tempo": [
                "N√£o tenho tempo",
                "Estou muito ocupado",
                "Talvez mais tarde"
            ],
            "confianca": [
                "N√£o conhe√ßo voc√™s",
                "Preciso pesquisar mais",
                "J√° fui enganado antes"
            ],
            "necessidade": [
                "N√£o preciso disso",
                "J√° tenho algo parecido",
                "N√£o √© prioridade agora"
            ],
            "decisao": [
                "Preciso conversar com minha esposa",
                "N√£o decido sozinho",
                "Vou pensar"
            ]
        }

        logger.info("Anti-Objection System inicializado com arsenal completo")

    def generate_anti_objection_system(self, product_data: Dict[str, Any]) -> Dict[str, Any]:
        """Gera sistema anti-obje√ß√£o personalizado"""

        try:
            logger.info("üõ°Ô∏è Gerando sistema anti-obje√ß√£o para 5 obje√ß√µes")

            # Salvar dados de entrada
            self.auto_save.save_stage("anti_objecao_entrada", product_data)

            # Identificar obje√ß√µes principais
            main_objections = self._identify_main_objections(product_data)

            # Salvar obje√ß√µes analisadas
            self.auto_save.save_stage("objecoes_analisadas", {"objections": main_objections})

            # Gerar contra-ataques
            counter_attacks = self._generate_counter_attacks(main_objections, product_data)

            # Salvar contra-ataques
            self.auto_save.save_stage("contra_ataques", counter_attacks)

            # Gerar scripts personalizados
            try:
                personalized_scripts = self._generate_personalized_scripts(counter_attacks, product_data)
            except Exception as e:
                logger.error(f"‚ùå Erro cr√≠tico ao gerar scripts personalizados: {e}")
                self.auto_save.save_stage("ERRO_scripts_personalizados", {"error": str(e)})
                personalized_scripts = self._create_basic_scripts(product_data)

            # Sistema completo
            anti_objection_system = {
                "main_objections": main_objections,
                "counter_attacks": counter_attacks,
                "personalized_scripts": personalized_scripts,
                "objection_prevention": self._generate_objection_prevention(product_data),
                "psychological_triggers": self._generate_psychological_triggers(product_data)
            }

            logger.info("‚úÖ Sistema anti-obje√ß√£o gerado com sucesso")
            return anti_objection_system

        except Exception as e:
            logger.error(f"‚ùå Erro ao gerar sistema anti-obje√ß√£o: {e}")
            self.auto_save.save_stage("ERRO_anti_objecao_sistema", {"error": str(e)})

            # Retornar sistema b√°sico
            logger.warning("üîÑ Gerando sistema anti-obje√ß√£o b√°sico como fallback...")
            return self._create_basic_anti_objection_system(product_data)

    def _identify_main_objections(self, product_data: Dict[str, Any]) -> List[Dict[str, Any]]:
        """Identifica as principais obje√ß√µes para o produto"""

        segment = product_data.get('segmento', 'Geral')
        price_range = product_data.get('preco', 'N√£o informado')

        # Obje√ß√µes baseadas no segmento
        main_objections = []

        if 'medicina' in segment.lower() or 'medico' in segment.lower():
            main_objections = [
                {
                    "type": "confianca",
                    "objection": "N√£o confio em cursos online para √°rea m√©dica",
                    "frequency": "Alta",
                    "intensity": "Forte"
                },
                {
                    "type": "tempo",
                    "objection": "N√£o tenho tempo com minha agenda m√©dica",
                    "frequency": "Muito Alta",
                    "intensity": "Muito Forte"
                },
                {
                    "type": "preco",
                    "objection": "J√° invisto muito em congressos e cursos",
                    "frequency": "Alta",
                    "intensity": "Moderada"
                },
                {
                    "type": "necessidade",
                    "objection": "J√° sei telemedicina na pr√°tica",
                    "frequency": "Moderada",
                    "intensity": "Forte"
                },
                {
                    "type": "regulamentacao",
                    "objection": "As regras de telemedicina mudam muito",
                    "frequency": "Alta",
                    "intensity": "Forte"
                }
            ]
        else:
            # Obje√ß√µes gen√©ricas
            main_objections = [
                {"type": "preco", "objection": "Est√° muito caro", "frequency": "Alta", "intensity": "Forte"},
                {"type": "tempo", "objection": "N√£o tenho tempo", "frequency": "Muito Alta", "intensity": "Forte"},
                {"type": "confianca", "objection": "N√£o conhe√ßo voc√™s", "frequency": "Moderada", "intensity": "Moderada"},
                {"type": "necessidade", "objection": "N√£o preciso disso agora", "frequency": "Alta", "intensity": "Moderada"},
                {"type": "decisao", "objection": "Preciso pensar", "frequency": "Muito Alta", "intensity": "Fraca"}
            ]

        return main_objections

    def _generate_counter_attacks(self, objections: List[Dict[str, Any]], product_data: Dict[str, Any]) -> Dict[str, Any]:
        """Gera contra-ataques para cada obje√ß√£o"""

        counter_attacks = {}

        for objection in objections:
            obj_type = objection["type"]
            obj_text = objection["objection"]

            if obj_type == "confianca":
                counter_attacks[obj_type] = {
                    "immediate_response": "Entendo perfeitamente sua preocupa√ß√£o. Deixe-me mostrar nossos resultados...",
                    "evidence": [
                        "Depoimentos de m√©dicos que j√° fizeram o curso",
                        "Certifica√ß√µes e credenciais da institui√ß√£o",
                        "Casos de sucesso documentados"
                    ],
                    "reframe": "Na verdade, sua prud√™ncia mostra que voc√™ √© um profissional s√©rio"
                }
            elif obj_type == "tempo":
                counter_attacks[obj_type] = {
                    "immediate_response": "Dr., justamente por isso criamos um m√©todo que se adapta √† sua agenda",
                    "evidence": [
                        "Aulas de 15-20 minutos",
                        "Acesso vital√≠cio para estudar quando puder",
                        "App mobile para estudar entre consultas"
                    ],
                    "reframe": "O tempo que investe agora vai economizar horas no futuro"
                }
            elif obj_type == "preco":
                counter_attacks[obj_type] = {
                    "immediate_response": "Vou te mostrar como esse investimento se paga sozinho",
                    "evidence": [
                        "ROI m√©dio de 300% no primeiro m√™s",
                        "Economia de tempo vale mais que o investimento",
                        "Parcelamento sem juros dispon√≠vel"
                    ],
                    "reframe": "N√£o √© um gasto, √© um investimento no seu futuro profissional"
                }
            else:
                counter_attacks[obj_type] = {
                    "immediate_response": f"Entendo sua preocupa√ß√£o sobre {obj_text}",
                    "evidence": ["Evid√™ncia personalizada ser√° gerada"],
                    "reframe": "Vamos ver isso de outra perspectiva"
                }

        return counter_attacks

    def _generate_personalized_scripts(self, counter_attacks: Dict[str, Any], product_data: Dict[str, Any]) -> Dict[str, Any]:
        """Gera scripts personalizados usando IA"""

        prompt = f"""
        Crie scripts de vendas personalizados para superar obje√ß√µes no segmento: {product_data.get('segmento', 'Geral')}

        Produto: {product_data.get('produto', 'Produto/Servi√ßo')}
        P√∫blico: {product_data.get('publico', 'Profissionais')}

        Para cada obje√ß√£o, crie:
        1. Script de resposta imediata (30-60 segundos)
        2. Apresenta√ß√£o de evid√™ncias (1-2 minutos) 
        3. Fechamento com reframe (30 segundos)

        Obje√ß√µes principais:
        {json.dumps(list(counter_attacks.keys()), indent=2)}

        Retorne em formato JSON estruturado.
        """

        try:
            response = self.ai_manager.generate_content(prompt, max_length=3000)

            # Tentar parsear JSON
            try:
                scripts = json.loads(response)
                return scripts
            except json.JSONDecodeError:
                logger.warning("‚ö†Ô∏è IA retornou JSON inv√°lido para scripts")
                return self._create_basic_scripts(product_data)

        except Exception as e:
            logger.error(f"‚ùå Erro ao gerar scripts com IA: {e}")
            return self._create_basic_scripts(product_data)

    def _create_basic_scripts(self, product_data: Dict[str, Any]) -> Dict[str, Any]:
        """Cria scripts b√°sicos quando a IA falha"""

        segment = product_data.get('segmento', 'Geral')

        if 'medic' in segment.lower():
            return {
                "confianca": {
                    "script": "Dr., entendo sua preocupa√ß√£o. Somos reconhecidos pelo CFM e temos mais de 500 m√©dicos formados.",
                    "evidencias": "Mostrar certifica√ß√µes e depoimentos",
                    "fechamento": "Sua prud√™ncia mostra que voc√™ far√° bom uso do conhecimento"
                },
                "tempo": {
                    "script": "Criamos especificamente para m√©dicos ocupados. S√£o apenas 15 min por dia.",
                    "evidencias": "Demonstrar flexibilidade da plataforma",
                    "fechamento": "O tempo investido agora economizar√° horas no futuro"
                },
                "preco": {
                    "script": "Vou mostrar como se paga sozinho na primeira consulta de telemedicina.",
                    "evidencias": "Calcular ROI baseado na pr√°tica m√©dica",
                    "fechamento": "√â um investimento, n√£o um gasto"
                }
            }

        return {
            "genericos": {
                "script": "Entendo sua preocupa√ß√£o. Vamos esclarecer isso juntos.",
                "evidencias": "Apresentar dados relevantes",
                "fechamento": "Agora faz mais sentido?"
            }
        }

    def _generate_objection_prevention(self, product_data: Dict[str, Any]) -> Dict[str, Any]:
        """Gera estrat√©gias para prevenir obje√ß√µes"""

        return {
            "opening_statements": [
                "Antes de come√ßar, quero esclarecer os pontos que mais geram d√∫vidas",
                "Vou ser transparente sobre tudo desde o in√≠cio",
                "Deixe-me mostrar exatamente o que voc√™ est√° recebendo"
            ],
            "social_proof": [
                "Mais de 500 profissionais j√° transformaram suas carreiras",
                "Dr. Jo√£o Silva aumentou sua renda em 40% no primeiro m√™s",
                "Reconhecido pelas principais entidades m√©dicas"
            ],
            "urgency_builders": [
                "As vagas s√£o limitadas para manter a qualidade",
                "O pre√ßo promocional acaba em 48 horas",
                "A pr√≥xima turma s√≥ abre em 3 meses"
            ]
        }

    def _generate_psychological_triggers(self, product_data: Dict[str, Any]) -> Dict[str, Any]:
        """Gera gatilhos psicol√≥gicos para superar resist√™ncias"""

        return {
            "reciprocidade": [
                "Oferecer conte√∫do gratuito antes de vender",
                "Compartilhar informa√ß√µes valiosas",
                "Dar algo de valor sem pedir nada"
            ],
            "autoridade": [
                "Credenciais e experi√™ncia do instrutor",
                "Reconhecimentos e pr√™mios",
                "Casos de sucesso documentados"
            ],
            "escassez": [
                "Vagas limitadas",
                "Oferta por tempo limitado",
                "Exclusividade do grupo"
            ],
            "consistencia": [
                "Fazer micro-compromissos",
                "Confirmar interesse e necessidade",
                "Criar senso de compromisso"
            ]
        }

    def _create_basic_anti_objection_system(self, product_data: Dict[str, Any]) -> Dict[str, Any]:
        """Cria sistema anti-obje√ß√£o b√°sico"""

        return {
            "main_objections": [
                {"type": "preco", "objection": "Est√° caro", "frequency": "Alta"},
                {"type": "tempo", "objection": "Sem tempo", "frequency": "Alta"},
                {"type": "confianca", "objection": "N√£o conhe√ßo", "frequency": "Moderada"}
            ],
            "counter_attacks": {
                "preco": {"response": "Vou mostrar o ROI", "evidence": ["Calculadora de retorno"]},
                "tempo": {"response": "Flex√≠vel e pr√°tico", "evidence": ["Acesso mobile"]},
                "confianca": {"response": "Somos reconhecidos", "evidence": ["Certifica√ß√µes"]}
            },
            "scripts": self._create_basic_scripts(product_data),
            "prevention": {"social_proof": ["Depoimentos", "Casos de sucesso"]},
            "triggers": {"urgency": ["Vagas limitadas"], "authority": ["Especialistas"]}
        }

    def generate_complete_anti_objection_system(self, objections_list: List[str], avatar_data: Dict[str, Any], context_data: Dict[str, Any]) -> Dict[str, Any]:
        """Gera sistema anti-obje√ß√£o completo para o unified analysis engine"""
        try:
            logger.info("üõ°Ô∏è Gerando sistema anti-obje√ß√£o completo")

            # Usar dados do contexto como product_data
            product_data = {
                'segmento': context_data.get('segmento', 'Geral'),
                'produto': context_data.get('produto', 'Produto/Servi√ßo'),
                'publico': context_data.get('publico', 'Profissionais'),
                'preco': context_data.get('preco', 'N√£o informado')
            }

            # Identificar obje√ß√µes principais
            main_objections = self._identify_main_objections(product_data)

            # Adicionar obje√ß√µes customizadas da lista
            for objection in objections_list[:5]:  # M√°ximo 5 obje√ß√µes
                main_objections.append({
                    "type": "custom",
                    "objection": objection,
                    "frequency": "Alta",
                    "intensity": "Forte"
                })

            # Gerar contra-ataques
            counter_attacks = self._generate_counter_attacks(main_objections, product_data)

            # Gerar scripts personalizados
            try:
                personalized_scripts = self._generate_personalized_scripts(counter_attacks, product_data)
            except Exception as e:
                logger.error(f"‚ùå Erro ao gerar scripts: {e}")
                personalized_scripts = self._create_basic_scripts(product_data)

            # Sistema completo
            complete_system = {
                "main_objections": main_objections,
                "counter_attacks": counter_attacks,
                "personalized_scripts": personalized_scripts,
                "objection_prevention": self._generate_objection_prevention(product_data),
                "psychological_triggers": self._generate_psychological_triggers(product_data),
                "avatar_integration": {
                    "avatar_fears": avatar_data.get('medos_profundos', []),
                    "avatar_desires": avatar_data.get('aspiracoes_secretas', []),
                    "targeted_responses": self._create_avatar_targeted_responses(avatar_data)
                }
            }

            logger.info("‚úÖ Sistema anti-obje√ß√£o completo gerado")
            return complete_system

        except Exception as e:
            logger.error(f"‚ùå Erro no sistema anti-obje√ß√£o completo: {e}")
            return self._create_basic_anti_objection_system(product_data)

    def _create_avatar_targeted_responses(self, avatar_data: Dict[str, Any]) -> Dict[str, Any]:
        """Cria respostas direcionadas baseadas no avatar"""
        return {
            "fear_based_responses": [
                f"Entendo que voc√™ possa ter receio sobre {fear}" 
                for fear in avatar_data.get('medos_profundos', ['investir sem garantias'])[:3]
            ],
            "desire_based_responses": [
                f"Imagino que voc√™ sonha em {desire}" 
                for desire in avatar_data.get('aspiracoes_secretas', ['ter sucesso profissional'])[:3]
            ],
            "personality_match": {
                "communication_style": avatar_data.get('personalidade', 'Direto e objetivo'),
                "trust_builders": ["Dados concretos", "Casos reais", "Garantias s√≥lidas"]
            }
        }

# Inst√¢ncia global para ser importada
anti_objection_system = AntiObjectionSystem()